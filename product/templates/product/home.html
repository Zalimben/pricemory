{% extends 'product/base.html' %}
{% load static %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/home.js' %}"></script>
{% endblock %}

{% block libs %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
{% endblock %}

{% block content %}

    <div class="container">

        <div class="columns has-text-centered mb-5">
            <div class="column is-12">

                <h1 class="title">Historial de precios de Tiendas Paraguayas</h1>
                <h1 class="subtitle">{{ productsCount }} productos registrados desde el {{ sinceDate.year }}</h1>
            </div>
        </div>

        <!-- < Search Form > -->
        <div class="columns">
            <div class="column"></div>

            <form method="get" action="" id="search-form" class="box column is-three-fifths">
                <div class="columns">
                    <div class="column"></div>
                    <div class="column is-four-fifths">

                        <div class="field">
                            <label class="label">Nombre</label>
                            <div class="control">{{ myFilter.form.name }}</div>
                        </div>

                        <div class="field">
                            <label class="label">URL</label>
                            <div class="control">{{ myFilter.form.url }}</div>
                        </div>

                        <div class="field">
                            <label class="label">Codigo de Barras</label>
                            <div class="control">{{ myFilter.form.barcode }}</div>
                        </div>

                        <div class="field is-horizontal">
                            <div class="field-body">

                                <div class="field">
                                    <label class="label">Tienda</label>
                                    <div class="control">
                                        <div class="select">{{ myFilter.form.shop }}</div>
                                    </div>
                                </div>

                                <div class="field">
                                    <label class="label">Marca</label>
                                    <div class="control">
                                        <div class="select">{{ myFilter.form.brand }}</div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="field is-grouped is-grouped-centered mt-6">
                            <div class="control">
                                <button type="submit" class="button is-info">Buscar</button>
                            </div>
                        </div>

                    </div>
                    <div class="column"></div>
                </div>
            </form>
            <div class="column"></div>
        </div>
        <!-- </ Search Form > -->

        <!-- < Results Table > -->
        {% if products %}
            <div class="box">

                <table class="table is-striped">
                    <thead>
                    <tr>
                        <th class="has-text-centered">Codigo de Barras</th>
                        <th class="has-text-centered">Nombre</th>
                        <th class="has-text-centered">Tienda</th>
                        <th class="has-text-centered">Marca</th>
                        <th class="has-text-centered">URL</th>
                        <th class="sortable" sortable="num_prices">Historial de Precio</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for product in products %}
                        <tr>
                            <td class="has-text-centered">{{ product.barcode|default_if_none:"-" }}</td>
                            <td>{{ product.name }}</td>
                            <td class="has-text-centered">{{ product.shop.name }}</td>
                            <td class="has-text-centered">
                                {% if product.brand %} {{ product.brand.name }} {% else %}-{% endif %}
                            </td>

                            <td>
                                <a class="button button is-link"
                                   href="{{ product.url }}" target="_blank">
                                    <span class="icon is-small"><i class="fas fa-external-link-alt"></i></span>
                                </a>
                            </td>


                            <td class="has-text-centered">
                                <a class="button button is-primary"
                                   href="{% url 'chart' %}?product_id={{ product.id }}">
                                    <span>{{ product.num_prices }}</span>
                                    <span class="icon is-small"><i class="fas fa-chart-line"></i></span>
                                </a>
                            </td>

                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

                <!--Pagination -->
                <!-- Adapted from https://www.ordinarycoders.com/blog/article/django-pagination -->
                <nav class="pagination is-centered mt-5" role="navigation" aria-label="pagination">
                    <ul class="pagination-list">
                        <a class="pagination-link"
                                {% if products.has_previous %}
                           href="?{{ parameters }}&page={{ products.previous_page_number }}"
                                {% else %}
                           title="This is the first page" disabled
                                {% endif %}
                        >
                            Anterior
                        </a>

                        {% if products.number|add:'-2' > 1 %}
                            <li><a class="pagination-link" aria-label="Goto page 1"
                                   href="?page=1&{{ parameters }}">1</a>
                            </li>
                            <li><a class="pagination-ellipsis"
                                   href="?{{ parameters }}&page={{ products.number|add:'-3' }}">&hellip;</a>
                            </li>
                        {% endif %}


                        {% for page in products.paginator.page_range %}
                            {% if products.number == page %}
                                <li><a class="pagination-link is-current" aria-label="Page {{ page }}"
                                       aria-current="page">{{ page }}</a></li>
                            {% elif page > products.number|add:'-3' and page < products.number|add:'3' %}
                                <li><a class="pagination-link" aria-label="Goto page {{ page }}"
                                       href="?{{ parameters }}&page={{ page }}">{{ page }}</a></li>
                            {% endif %}
                        {% endfor %}


                        {% if products.paginator.num_pages > products.number|add:'2' %}
                            <li><a class="pagination-ellipsis"
                                   href="?{{ parameters }}&page={{ products.number|add:'3' }}">&hellip;</a>
                            </li>


                            <li>
                                <a class="pagination-link" aria-label="Goto page 1"
                                   href="?{{ parameters }}&page={{ products.paginator.num_pages }}"
                                >
                                    {{ products.paginator.num_pages }}
                                </a>
                            </li>
                        {% endif %}

                        <a class="pagination-link"
                                {% if products.has_next %}
                           href="?{{ parameters }}&page={{ products.next_page_number }}"
                                {% else %}
                           title="This is the last page" disabled
                                {% endif %}
                        >
                            Siguiente
                        </a>

                    </ul>
                </nav>
                <!--end of Pagination-->
            </div>
            <!-- </ Results Table > -->
        {% endif %}

    </div>

{% endblock %}


